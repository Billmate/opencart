<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Billmate Get Address</name>
    <author>Boxedsolutions Skaraborg</author>
    <link>http://www.billmate.se</link>
    <version>1.1.1</version>
    <code>billmate_getaddress</code>
    <file path="catalog/language/english/checkout/checkout.php">
        <operation>
        <search><![CDATA[$_['entry_shipping'] 	             = 'My delivery and billing addresses are the same.';]]></search>
        <add position="after">
            <![CDATA[
                        $_['entry_pno'] = 'Social Security number / Corporate number';
                        $_['entry_getaddress_button'] = 'Get Address';
            ]]>
        </add>
        </operation>
    </file>
    <file path="catalog/language/swedish/checkout/checkout.php">
        <operation>
        <search><![CDATA[$_['entry_shipping'] 	             = 'Min leveransadress och fakturaadress är samma.';]]></search>
        <add position="after">
            <![CDATA[
                        $_['entry_pno'] = 'Personnummer / Organisationsnummer';
                        $_['entry_getaddress_button'] = 'Hämta address';
            ]]>
        </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/payment_address.php">
        <operation>
        <search><![CDATA[$data['text_loading'] = $this->language->get('text_loading');]]></search>
        <add position="after">
            <![CDATA[
            $data['entry_pno'] = $this->language->get('entry_pno');
            $data['entry_getaddress_button'] = $this->language->get('entry_getaddress_button');
            $data['billmate_pno'] = isset($this->session->data['billmate_pno']) ? $this->session->data['billmate_pno'] : false;

            ]]>
        </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/guest.php|catalog/controller/checkout/register.php">
        <operation>
            <search><![CDATA[$data['text_loading'] = $this->language->get('text_loading');]]></search>
            <add position="after">
                <![CDATA[
            $data['entry_pno'] = $this->language->get('entry_pno');
            $data['entry_getaddress_button'] = $this->language->get('entry_getaddress_button');
            $data['billmate_pno'] = isset($this->session->data['billmate_pno']) ? $this->session->data['billmate_pno'] : false;
            ]]>
            </add>
        </operation>
    </file>


    <file path="catalog/view/theme/default/template/checkout/guest.tpl|catalog/view/theme/default/template/checkout/register.tpl">
        <operation>
            <search index="0"><![CDATA[<div class="form-group required">]]></search>
            <add position="before">
                <![CDATA[
               <div class="form-group">
                  <label class="control-label" for="input-payment-pno"><?php echo $entry_pno; ?></label>
                  <div>
                    <input type="text" name="billmate_pno" style="display:inline-block;width:70%;" value="<?php echo ($billmate_pno) ? $billmate_pno : ''; ?>" placeholder="<?php echo $entry_pno; ?>" id="input-payment-pno" class="form-control" />
                    <button class="btn btn-primary" type="button" id="getaddress"><?php echo $entry_getaddress_button; ?></button>
                  </div>
               </div>
               <script type="text/javascript">
                    $(document).ready(function(){
                        $('#getaddress').on('click',function(){
                            var pno = $('#input-payment-pno').val();
                            if(pno != ''){
                                $.ajax({
                                    url: 'index.php?route=payment/billmate_invoice/getaddress',
                                    data: {pno: pno},
                                    type: 'post',
                                    success: function(response){
                                        var result = JSON && JSON.parse(response) || $.parseJSON(response);
                                        if(result.success){
                                            if(typeof result.data.company == 'undefined'){
                                                $('#input-payment-firstname').val(result.data.firstname)
                                                $('#input-payment-lastname').val(result.data.lastname)
                                            } else {
                                                $('#input-payment-company').val(result.data.company)
                                            }
                                            $('#input-payment-email').val(result.data.email)
                                            $('#input-payment-telephone').val(result.data.phone)
                                            $('#input-payment-address-1').val(result.data.street)
                                            $('#input-payment-city').val(result.data.city)
                                            $('#input-payment-postcode').val(result.data.zip)

    										$('select[name="country_id"]').val(result.data.country_id);

                                        }
                                    }
                                })
                            }
                        })
                    });
               </script>
            ]]>
            </add>
        </operation>
    </file>
</modification>